/*! MainApp 19-09-2013 */
function runValidity(e){$container=e.$container,outputMode=e.outputMode,specialValidation=e.specialValidation,skipAutoValidity=e.skipAutoValidity,setupSettings=e.setupSettings;var t=setupSettings||{};if(t.outputMode=outputMode||"modal",$.validity.setup(t),window.currentValidityContainer=$container,$.validity.start(),void 0===skipAutoValidity&&(skipAutoValidity=!1),"function"==typeof specialValidation&&specialValidation($container),!skipAutoValidity){var i=$container.attr("data-require-all");i!==void 0?$container.find("input, select, textarea").require():$container.find("input, select, textarea").each(function(){$input=$(this);var e=$input.attr("data-required")||$input.attr("required"),t=$input.attr("data-match");if(e!==void 0&&e!==!1&&$input.require(),!isNothing(t)){if("url"==t)""!==$input.val()&&0>$input.val().indexOf("http")&&$input.val("http://"+$input.val());else if(-1!=t.toLowerCase().indexOf("date")){var i=$input.attr("data-date-range");if(!isNothing(i)&&!isNothing($input.val())){var s=new Date;"current-past"==i?$input.assert(s>=new Date($input.val()),"The date must be the current date or a past date."):"current-future"==i?$input.assert(new Date($input.val())>=s,"The date must be the current date or a future date."):"past"==i?$input.assert(s>new Date($input.val()),"The date must be a past date."):"future"==i&&$input.assert(new Date($input.val())>s,"The date must be a future date.")}var r=$input.attr("data-date-great-than"),a=$input.attr("data-date-great-than-name");if(!isNothing(r)&&!isNothing($input.val())&&$(r).length>0){var n=$(r).val();isNothing(n)&&(n=0);var o=$input.val();$input.assert(moment(o).unix()-moment(n).unix()>0,"This date must be greater than "+a)}}else if("number"==t){var l=$input.attr("data-range");if(!isNothing(l))try{var c=l.split(" "),d=c[0],u=c[1];$input.range(d,u)}catch(h){console.log("runValidity:data-range: "),console.log(h)}}$input.match(t)}})}return window.currentValidityContainer=null,$.validity.end()}function addValidityElementSupport(e){-1==$.validity.settings.elementSupport.indexOf(e)&&($.validity.settings.elementSupport+=", "+e)}function hideValidityModals(){$(".validity-modal-msg").click()}function toggleInlineEdits(e){e?($(".inline-readonly").hide(),$(".inline-edit").show()):($(".inline-readonly").show(),$(".inline-edit").hide())}function toggleInlineEditsContainer(e){var t=e.attr("inline-edit-state");(null===t||""===t)&&(t="edit"),"edit"==t?(hideInlineEdits(e),e.attr("inline-edit-state","readonly")):(showInlineEdits(e),e.attr("inline-edit-state","edit"))}function hideInlineEdits(e){e.find(".inline-readonly").show(),e.find(".inline-edit").hide()}function showInlineEdits(e){e.find(".inline-readonly").hide(),e.find(".inline-edit").show()}function flashMessage(e){var t;"string"==typeof e.message?(t={},t.message=e.message):t=e.message;var i,s,r=e.duration,a=e.template,n=e.className||"";(void 0===r||null===r)&&(r=2500),0===$("div#global-message").size()&&(s='<div id="global-message" class="modal hide"><div class="modal-body"></div></div>',$("body").append(s)),i=void 0===a||null===a||""===a?"<h3><center>{{message}}</center></h3>":a,a=Handlebars.compile(i),s=a(t),""!==n?$("#global-message").addClass(n):$("#global-message").removeClass(),$("#global-message").addClass("modal"),$("#global-message .modal-body").html(s),BLOCK_FLASH||(BLOCK_FLASH=!0,$("#global-message").fadeIn(function(){setTimeout(function(){$("#global-message").fadeOut(),BLOCK_FLASH=!1},r)}))}function renderPopovers(e){var t;t=null===e||null===e.$container?$(".popover-ui"):e.$container.find(".popover-ui"),t.popover(e)}function showOther(e,t,i){t.hide(),type=e.attr("type"),"checkbox"==type?(e.is(":checked")?t.show():t.val(""),e.click(function(){$(this).is(":checked")?t.show():t.hide()})):"multiple"==e.attr("multiple")?"object"==typeof i||("Other"==e.children().last().text()?t.show():t.hide()):"object"==typeof i?$.inArray(e.val(),i)>-1?t.show():t.hide():e.val()==i?t.show():t.hide(),e.on("change",function(){"object"==typeof i?$.inArray($(this).val(),i)>-1?t.show():t.hide():"multiple"==e.attr("multiple")?"object"==typeof i||("Other"==e.children().last().text()?t.show():t.hide()):$(this).val()==i?t.show():t.hide()})}function formatDateTime(e,t){e=e||Date();var i=t?moment.utc(e):moment(e);return i.format("M/D/YYYY h:mma")}function formatDate(e,t){e=e||Date();var i=t?moment.utc(e):moment(e);return i.format("MM/DD/YYYY")}function formatDateValue(e,t){e=e||Date();var i=t?moment.utc(e):moment(e);return i.format("YYYY-MM-DD")}function fixDate(e,t,i){if(t=t||"date",t=t.toLowerCase(),i=i||!1,"number"!=typeof e||i||(e=""+e),e===void 0||""===e)return"";switch(i||-1!==e.indexOf(":")||(e+=" 00:00:00"),toReturn="",t){case"date":toReturn=formatDate(e,i);break;case"datetime":toReturn=formatDateTime(e,i);break;case"value":toReturn=formatDateValue(e,i);break;default:toReturn=formatDate(e,i)}return toReturn}function fixDatesIn(e){e.find(".format-date").each(function(){$(this).text(fixDate($(this).text(),$(this).attr("data-date-type")))})}function jsToSFDate(e){return new Date(e).getTime()}function booleanToCheckmark(e){return output="",("true"==e||e===!0)&&(output='<i class="icon-ok"></i>'),output}function booleanToThumbs(e){return output='<i class="icon-thumbs-down"></i>',("true"==e||e===!0)&&(output='<i class="icon-thumbs-up"></i>'),output}function booleanToYesNo(e){return output="<span>No</span>",("true"==e||e===!0)&&(output="<span>Yes</span>"),output}function dateSFPHPFormat(e){e=e||Date();var t=moment(e);return t.format("YYYY-MM-DD")}function setPicklistOptions(e){var t;t=null===e.$select?e:e.$select;var i=t.attr("data-api-object"),s=t.attr("data-api-name"),r=t.attr("data-value");return null===r&&(r=""),e.skipOptions===!0?(null!==r&&""!==r&&t.find('option[value="'+r+'"]').attr("selected","selected"),void 0):(callService("getPicklistOptions",null,{object:i,field:s,value:r},function(e){t.html(e.options)},function(){flashMessage({message:"...Error getting select values..."})}),void 0)}function deactivateButton(e){e.addClass("disabled"),e.hasClass("btn-primary")?e.attr("btn-original-state","btn-primary"):e.hasClass("btn-success")?e.attr("btn-original-state","btn-success"):e.hasClass("btn-danger")?e.attr("btn-original-state","btn-danger"):e.hasClass("btn-warning")&&e.attr("btn-original-state","btn-warning"),e.removeClass("btn-primary, btn-success, btn-danger, btn-warning")}function activateButton(e){e.removeClass("disabled");var t=e.attr("btn-original-state");isNothing(t)||e.addClass(t)}function createOption(e,t,i){return null===i&&(i=""),'<option value="'+e+'" '+i+">"+t+"</option>"}function initialize(){$(function(){$("body").on("click",".toggle-inline",function(){$(".inline-edit").find("input, select, textarea").each(function(){$(this).is(":visible")?$(this).val($(this).data("original-value")):$(this).data("original-value",$(this).val())}),$(".inline-edit").find("input, select, textarea").filter('[data-default-val][value=" "]').val(function(){return $(this).attr("data-default-val")}),$(".inline-readonly,.inline-edit,.edit-toggle").toggle(),$(".inline-edit").each(function(){$(this).is(":visible")?$(this).find("input, select, textarea").each(function(){attr=$(this).attr("data-required"),"undefined"!=typeof attr&&attr!==!1&&$(this).closest(".control-group").addClass("error")}):$(this).find("input, select, textarea").closest(".control-group").removeClass("error")})}).on("click","a",function(){!$(this).hasClass("external-link")}).on("click",function(e){if($(e.target).hasClass("popover-ui")||0!==$(e.target).closest(".popover-ui").length||$(e.target).hasClass("popover-sticky")){if($(e.target).hasClass("popover-sticky"))return;$contextItem=$(e.target).hasClass("popover-ui")?$(this):$(e.target).closest(".popover-ui"),id=$contextItem.attr("id"),null!==id&&""!==id&&($popoversToHide=$('.popover-ui[id!="'+id+'"]'),$popoversToHide.length>0&&$popoversToHide.popover("hide"))}else $(".popover-ui").popover("hide")}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return e.length>0&&this.substring(this.length-e.length,this.length)===e}),addValidityElementSupport('[type="number"]'),addValidityElementSupport('[type="date"]'),$.validity.settings.cssClass="error"})}function htmlEncode(e){return $("<div/>").text(e).html()}function htmlDecode(e){return $("<div/>").html(e).text()}function isNothing(e){return void 0===e||null===e||""===e?!0:!1}function valueOrBlank(e){return void 0===e||null===e?"":e}function fixHTML5Dates(e){Modernizr.inputtypes.date||(isNothing(e)&&(e={}),e.past===!0?$('[type="date"]').datepicker({changeMonth:!0,changeYear:!0,maxDate:0,yearRange:"-100:+0"}):$('[type="date"]').datepicker({changeMonth:!0,changeYear:!0}))}function callService(e){var t,i=[];return new Backbone.Marionette.Callbacks,null!==e.objects&&(i.records=e.objects),isNothing(e.params)?e.params=[]:i.params=e.params,i=JSON.stringify(i),null===e.service?(flashMessage({message:"NO SERVICE PROVIDED."}),void 0):(t=e.service,SERVICE_TEST?(t=t.split("."),serviceFunction=window[t[0]+"Test"][t[1]],"success"==SERVICE_TEST_RESULT_TYPE?(result=serviceFunction.success.apply(e.params),e.successCallback(result),void 0):"failure"==SERVICE_TEST_RESULT_TYPE?(result=serviceFunction.failure.apply(e.params),e.errorCallback(result),void 0):(flashMessage({message:"NO SERVICE TEST RESULT TYPE SET"}),void 0)):(t=t.split("."),serviceFunction=window[t[0]][t[1]],SH=new serviceHandler(e),SH.successCallback=null!==e.successCallback?e.successCallback:function(){},SH.errorCallback=null!==e.errorCallback?e.errorCallback:function(){},e.params.push(SH.handle),serviceFunction.apply({},e.params),void 0))}function serviceHandler(e){var t=this;this.successCallback=function(){},this.errorCallback=function(){},this.handle=function(i,s){null!==i&&i.success===!1&&"Auth Failure"==i.message||!isNothing(s)&&!isNothing(s.message)&&-1!=s.message.indexOf("Logged in")?t.authFailure(i,s):null!==i&&i.success?t.successCallback(i,e.context):(console.log(s),isNothing(window.runningApp)||"JavascriptErrorService.createError"==e.service||window.runningApp.vent.trigger("CallService:error",{data:i,error:s,handleOptions:e}),t.errorCallback(i,e.context))},this.authFailure=function(){$.unblockUI!==void 0&&$.unblockUI(),alert("Your login has expired."),window.location.reload()},this.ajaxError=function(e,t){$.unblockUI!==void 0&&$.unblockUI(),console.log(e),console.log(t),alert("CallService encountered an error. Please Contact Administrator.")}}var BLOCK_FLASH=!1,sObject=Backbone.Model.extend({defaults:{_type:null,Id:null,_action:null,_children:[]},initialize:function(){this.set({_cid:this.cid})},clearFields:function(){for(var e in this.attributes)0===e.indexOf("_")||this.unset(e)},save:function(e,t,i,s){callService(e,[this.php_format()],t,i,s)},add_child:function(e){var t=this.get("_children");t.push(e),this.set({children:t})},createObjectFromForm:function(e){var t;return t=isNothing(e.$form)?e:e.$form,null===t?null:(this.set({_type:t.attr("data-api-object")}),attrs={},t.find("input, select, textarea").each(function(){var t=$(this),i=t.attr("data-api-name"),s=t.attr("type"),r="";if(!isNothing(i)){if("number"==s){var a=t.attr("step");r=isNothing(a)?parseInt(t.val(),10):-1!=a.indexOf(".")?parseFloat(t.val()):parseInt(t.val(),10)}else"date"==s||"ra-date"==s?(r=jsToSFDate(t.val()),(isNothing(r)||isNaN(r))&&(r=void 0)):"checkbox"==s?r=t.is(":checked")?"1":"0":"file"==s?(reader=new FileReader,reader.readAsDataURL(t.context.files[0])):(r=t.val(),e.safe&&(r=r.replace(/'/g,"\\'").replace(/"/g,'\\"')),e.htmlSafe&&(r=r.replace(/</g,"&lt;").replace(/>/g,"&gt;")));attrs[i]=r}}),this.set(attrs),this)}}),BLOCK_NAV=!1,BLOCK_NAV_ONCE=!1,BLOCK_NAV_MESSAGE="Sorry but navigation is blocked due to the page. Please read the page for what to do.",gridCollection=Backbone.Collection.extend({model:sObject}),gridItemView=Backbone.Marionette.ItemView.extend({events:{"click .remove-item":"removeItem"},removeItem:function(){this.model.collection.remove(this.model)},getsObjectFromForm:function(e){if(null!==e){e.$container=$(this.$el);var t=runValidity(e);t.valid?this.model.set({_validateError:!1}):this.model.set({_validateError:!0})}this.model.CreateObjectFromForm($(this.$el))},model:sObject}),gridCompositeView=Backbone.Marionette.CompositeView.extend({model:sObject,events:{"click .add-item":"addItem"},afterAdd:function(){},addItem:function(){var e=new sObject;e._myList=this,this.collection.add(e),this.afterAdd()},getsObjectsFromChildForms:function(e){_.each(this.children._views,function(t){t.getsObjectFromForm(e)})},isCollectionValidated:function(){var e=!0;return _.each(this.collection.models,function(t){t.get("_validateError")===!0&&(e=!1)}),e},getPHPsObjects:function(){var e=[];return _.each(this.collection.models,function(t){e.push(t.php_format())}),e}}),sObjects=Backbone.Collection.extend({model:sObject,setAttribute:function(e,t){void 0===this.attributes&&(this.attributes={}),void 0!==e&&(this.attributes[e]=t)},getAttribute:function(e){return void 0===this.attributes?null:this.attributes[e]},defaults:{type:null,objects:[]},format:function(){var e=this.models,t=[];for(i=0;e.length>i;i++)t.push(e[i].format());return t},absorb:function(e){if(!isNothing(e))for(i=0;e.length>i;i++)object=new sObject,object.absorb(e[i]),this.add(object)}});Number.prototype.toMoney=function(e,t,i){var s=this,r=isNaN(e)?2:Math.abs(e),a=t||".",n=i===void 0?",":i,o=0>s?"-":"",l=parseInt(s=Math.abs(s).toFixed(r),10)+"",c=(c=l.length)>3?c%3:0;return o+(c?l.substr(0,c)+n:"")+l.substr(c).replace(/(\d{3})(?=\d)/g,"$1"+n)+(r?a+Math.abs(s-l).toFixed(r).slice(2):"")},templates={templates:{},loadTemplates:function(e){var t=e.names,i=e.callback,s=e.path,r=this,a=function(n){var o=t[n];$.get(s+o+".html",function(s){$("<div>").html(s).find(".view-template").each(function(){r.templates[$(this).attr("id")]=$(this).wrap("<div />").parent().html()}),n++,t.length>n?a(n):"function"==typeof e.callback&&i()})};a(0)},get:function(e){return this.templates[e]}},Handlebars.registerHelper("decodeSFImage",function(e){return isNothing(e)?"No Image Found":$("<div/>").html(e).text()}),Handlebars.registerHelper("serveletImage",function(e,t){if(isNothing(e))return"No Image Found";var i;return i='<image src="'+window["servelet-link"]+e+'" alt="No Image Preview Available" ',isNothing(t)||(i+='style="max-height:'+t+'" '),i+="/>"}),Handlebars.registerHelper("checkboxValue",function(e){return 1===e||e===!0||"1"===e||"true"===e?"checked=checked":""}),Handlebars.registerHelper("valueToReadOnlyCheck",function(e){return 1===e||e===!0||"1"===e||"true"===e?'<i class="glyphicon-check" />':""}),Handlebars.registerHelper("selectedValue",function(e,t){return e==t?'selected="selected"':void 0}),Handlebars.registerHelper("selectOptions",function(e,t,i){if(isNothing(t))return flashMessage({message:"Failed to load select list options"}),console.log("error in select options:"+e+" : "+t),'<option value="ERROR">ERROR</option>';var s="";i===!0&&(s+='<option value="" class="default">Please Select...</option>');for(var r=0;t.length>r;r++)s+='<option value="'+t[r].value+'"',isNothing(e)&&t[r].defaultValue?s+=' selected="selected" class="default"':e==t[r].value&&(s+=' selected="selected"'),s+=">"+t[r].label+"</option>";return s}),Handlebars.registerHelper("numbersOnly",function(e){return e=String.valueOf(e),e.replace(/[^0-9]/g,"")}),Handlebars.registerHelper("formatMoney",function(e){return isNaN(e)?"0.00":e=Number(e).toMoney()}),Handlebars.registerHelper("formatDate",function(e){return fixDate(e,"date")}),Handlebars.registerHelper("formatSFDate",function(e){return offset=6e4*(new Date).getTimezoneOffset(),isNothing(e)?"":isNothing(Modernizr)?moment(new Date(e+offset)).format("YYYY-MM-DD"):Modernizr.inputtypes.date?moment(new Date(e+offset)).format("YYYY-MM-DD"):moment(new Date(e+offset)).format("MM/DD/YYYY")}),Handlebars.registerHelper("formatSFNiceDate",function(e){return offset=6e4*(new Date).getTimezoneOffset(),isNothing(e)?"":moment(new Date(e+offset)).format("MM/DD/YYYY")}),Handlebars.registerHelper("formatSFNiceDateTime",function(e){return offset=6e4*(new Date).getTimezoneOffset(),isNothing(e)?"":moment(new Date(e+offset)).format("MM/DD/YYYY h:mm:ss a")}),Handlebars.registerHelper("momentJSTimeAgo",function(e){return offset=6e4*(new Date).getTimezoneOffset(),isNothing(e)?"":moment(new Date(e+offset)).fromNow()}),Handlebars.registerHelper("formatDateTime",function(e){return fixDate(e,"datetime")}),Handlebars.registerHelper("formatDateValue",function(e){return fixDate(e,"value")}),Handlebars.registerHelper("formatUTCDate",function(e){return fixDate(e,"date",!0)}),Handlebars.registerHelper("formatUTCDateTime",function(e){return fixDate(e,"datetime",!0)}),Handlebars.registerHelper("formatUTCDateValue",function(e){return fixDate(e,"value",!0)}),Handlebars.registerHelper("atLeastHelper",function(e,t){if(void 0===t||"Null"==t||0===t||null===t)return"No";var i=t>=e;return i===!0?"Yes":"No"}),Handlebars.registerHelper("greaterThan",function(e,t){return e>t?!0:!1}),Handlebars.registerHelper("lessThan",function(e,t){return t>e?!0:!1}),Handlebars.registerHelper("replaceNewline",function(e){return isNothing(e)?"":e.replace(/\n/g,"<br />")}),Handlebars.registerHelper("ifEquals",function(e,t,i){return e==t?i.fn(this):i.inverse(this)}),Handlebars.registerHelper("ifNotEquals",function(e,t,i){return e!=t?i.fn(this):i.inverse(this)}),Handlebars.registerHelper("ifLessThan",function(e,t,i){return t>e?i.fn(this):i.inverse(this)}),Handlebars.registerHelper("ifGreaterThan",function(e,t,i){return e>t?i.fn(this):i.inverse(this)}),Handlebars.registerHelper("ifIn",function(e,t,i){return _.each(t,function(t){return e==t?i.fn(this):void 0}),i.inverse(this)}),Handlebars.registerHelper("ifStringContains",function(e,t,i){return-1!=e.indexOf(t)?i.fn(this):i.inverse(this)}),Handlebars.registerHelper("select",function(e,t){var i=$("<select />").html(t.fn(this));return isNothing(e)?e="":i.find("[value="+e+"]").attr({selected:"selected"}),i.html()}),Handlebars.registerHelper("debug",function(e){console.log("Current Context"),console.log("===================="),console.log(this),e&&(console.log("Value"),console.log("===================="),console.log(e))}),Handlebars.registerHelper("ifStringContains",function(e,t,i){return e||(e=""),-1!=e.indexOf(t)?i.fn(this):i.inverse(this)}),_.extend(Marionette.TemplateCache,{get:function(e){return Handlebars.compile($(templates.get(e)).html())}}),Marionette.View.originalClose=Marionette.View.close,Marionette.View=_.extend(Marionette.View,{getTemplate:function(){return this.template},close:function(){this.originalClose(),$(".validity-modal-msg").click()}}),_.extend(Marionette.Region.prototype,Backbone.Events,{swap:function(e){this.ensureEl(),this.open(e),e._isRendered===!1||e._firstRender===!0?(e.render(),Marionette.triggerMethod.call(e,"show"),Marionette.triggerMethod.call(this,"show",e)):(e.delegateEvents(),Marionette.triggerMethod.call(e,"swap"),Marionette.triggerMethod.call(this,"swap",e)),this.currentView=e},hardDrop:function(e){this.ensureEl(),this.close(),this.open(e),(e._isRendered===!1||e._firstRender===!0)&&(e.render(),Marionette.triggerMethod.call(e,"show"),Marionette.triggerMethod.call(this,"show",e)),e.delegateEvents(),Marionette.triggerMethod.call(e,"drop"),Marionette.triggerMethod.call(this,"drop",e),this.currentView=e}}),$.fn.popover.Constructor.prototype=_.extend($.fn.popover.Constructor.prototype,{originalBootstrapTooltipShow:$.fn.popover.Constructor.prototype.show,show:function(){this.originalBootstrapTooltipShow(),"function"==typeof this.callback&&this.callback()},originalBootstrapTooltipInit:$.fn.popover.Constructor.prototype.init,init:function(e,t,i){this.originalBootstrapTooltipInit(e,t,i),null!==i.callback&&(this.callback=i.callback),null!==i.contentTemplate&&(this.contentTemplate=i.contentTemplate),null!==i.addClass&&(this.options.template=this.options.template.replace('class="popover"','class="popover '+i.addClass+'"'))},originalBootstrapPopoverGetContent:$.fn.popover.Constructor.prototype.getContent,getContent:function(){return null!==this.contentTemplate&&void 0!==this.contentTemplate?(templateFunction=Handlebars.compile(this.contentTemplate),templateFunction(this.options.content)):this.originalBootstrapPopoverGetContent()}}),function(e){e.fn.twinBoxMultiSelectList=function(t){function i(e){var t=e.attr("selected");return t&&"selected"==t}function s(){return e(this).change(),e(this).slideUp("fast",function(){var t=e(this),i=t.parent(),r=t.data("option");t=t.remove().data("option",r).click(s);var o=null;return"selected"==i.attr("usageType")?(t.find(".remove-minus").remove(),t.append('<span class="pull-right add-plus">+</span>'),o=a,isNothing(r)||(r.removeAttr("selected"),r.attr("selected",!1))):(o=n,t.find(".add-plus").remove(),t.append('<span class="pull-right remove-minus">-</span>'),isNothing(r)||r.attr("selected","selected")),t.appendTo(o),t.slideDown(),this})}var r=e.extend(!0,{styles:{containerClass:"container-list",selectedItemClass:"selected-item",width:"auto",height:"auto"},append2TargetElem:!0},t),a=e("<ul/>").css("max-height",r.styles.height).css("width",r.styles.width).css("min-height",r.styles.height).attr("class",r.styles.containerClass).attr("usageType","available"),n=a.clone();if(n.attr("usageType","selected"),isNothing(t.choices))this.find("option").each(function(){var t=e(this),s=e("<li/>").html(t.html());s.data("option",t),i(t)?(s.append('<span class="pull-right remove-minus">-</span>'),s.appendTo(n)):(s.append('<span class="pull-right add-plus">+</span>'),s.appendTo(a))});else{var o;o=isNothing(t.value)?e(this).val():t.value,isNothing(o)&&(o=""),_.each(t.choices,function(t){var i=e("<li/>").html('<span class="value">'+t.value+"</span>");isNothing(t.otherValue)||i.attr("other-value",t.otherValue),isNothing(t.id)?(i.append('<span class="pull-right add-plus">+</span>'),i.appendTo(a)):(i.attr("id",t.id),i.append('<span class="pull-right remove-minus">-</span>'),i.appendTo(n))})}return r.append2TargetElem?(a.appendTo(e(t.availableList)),n.appendTo(e(t.selectedList))):(e(t.availableList).html(a),e(t.selectedList).html(n)),r.searchBox&&e(r.searchBox).keyup(function(){var t=e(this).val().toLowerCase();a.find("li").each(function(){var i=e(this);0>i.html().toLowerCase().indexOf(t)?i.hide():i.show()})}),a.find("li").click(s),n.find("li").click(s),this.hide(),this}}(jQuery),sObject=sObject.extend({format:function(){var e=jQuery.extend({},this.attributes),t=e._type;for(var i in e)(0===i.indexOf("_")||-1!=i.indexOf("__r"))&&delete e[i];return!isNothing(t)&&isNothing(e.Id)&&isNothing(e.sobjectType)?e.sobjectType=t:isNothing(e.Id)||delete e.sobjectType,e},defaults:{_service:"Service",_load:"query",_save:"save",_delete:"deleteObjects"},absorb:function(e){this.set(e)},callService:function(e){callService(e)},load:function(e){queryOrService=e.queryOrService,getAccess=e.getAccess,successHandle=e.successHandle,errorHandle=e.errorHandle,params=e.params,isNothing(getAccess)&&(getAccess=!1),this.getAccess=getAccess,isService=!1,"string"==typeof queryOrService?0!==queryOrService.indexOf("select ")&&(isService=!0):isNothing(queryOrService)&&(isNothing(this.query)?(queryOrService="select ",queryOrService+=this.fields.join(", "),queryOrService+=" from ",queryOrService+=this.objectType,isNothing(this.where)||(queryOrService+=" where "+this.where),isNothing(this.order)||(queryOrService+=" order by "+this.order),isNothing(this.nullsLast)||(queryOrService+=" nulls last")):queryOrService=this.query),isService?callService({service:queryOrService,params:params,successCallback:successHandle,errorCallback:errorHandle,context:this}):(isNothing(successHandle)&&(successHandle=this.defaultSuccessLoadHandle),isNothing(errorHandle)&&(errorHandle=this.defaultErrorLoadHandle),callService({service:this.get("_service")+"."+this.get("_load"),params:[queryOrService],successCallback:successHandle,errorCallback:errorHandle,context:this}))},save:function(e){objectType=e.objectType,isNothing(this.get("Id"))&&this.set({sobjectType:objectType}),successHandle=e.successHandle,errorHandle=e.errorHandle,isNothing(successHandle)&&(successHandle=this.defaultSuccessSaveHandle),isNothing(errorHandle)&&(errorHandle=this.defaultErrorSaveHandle),callService({service:this.get("_service")+"."+this.get("_save"),params:[objectType,[this.format()]],successCallback:successHandle,errorCallback:errorHandle,context:this})},deleteMe:function(e){objectType=e.objectType,successHandle=e.successHandle,errorHandle=e.errorHandle,isNothing(successHandle)&&(successHandle=this.defaultSuccessDeleteHandle),isNothing(errorHandle)&&(errorHandle=this.defaultErrorDeleteHandle),isNothing(this.get("Id"))&&(console.log("No Id given for deletion of:"),console.log(e),e.errorHandle({success:!1,message:"No Id given for deletion"})),callService({service:this.get("_service")+"."+this.get("_delete"),params:[objectType,[this.format()]],successCallback:successHandle,errorCallback:errorHandle,context:this})},defaultSuccessLoadHandle:function(e,t){t.absorb(e.records[0]),t.getAccess?callService({service:"Service.getRecordsAccess",params:[[t.get("Id")]],successCallback:function(e){t.set({_accessLevel:e.records[0].MaxAccessLevel}),t.trigger("load:success",{result:e})},errorCallback:function(e){console.log(e),flashMessage({message:"Failed to load Users access"}),t.trigger("load:success",{result:e})}}):t.trigger("load:success",{result:e})},defaultErrorLoadHandle:function(e,t){t.trigger("load:error",{result:e}),console.log(e),console.log(e.message)},defaultSuccessDeleteHandle:function(e,t){t.absorb(e.records[0]),t.trigger("delete:success",{result:e})},defaultErrorDeleteHandle:function(e,t){t.trigger("delete:error",{result:e}),console.log(e),console.log(e.message)},defaultSuccessSaveHandle:function(e,t){t.absorb(e.records[0]),t.trigger("save:success",{result:e})},defaultErrorSaveHandle:function(e,t){t.trigger("save:error",{result:e}),console.log(e),console.log(e.message)}}),sObjects=sObjects.extend({initialize:function(){this.setAttribute("_service","Service"),this.setAttribute("_load","query"),this.setAttribute("_loadWithAccess","queryWithAccess"),this.setAttribute("_save","save")},callService:function(e){callService(e)},load:function(e){if(queryOrService=e.queryOrService,params=e.params,successHandle=e.successHandle,errorHandle=e.errorHandle,getAccess=e.getAccess,isNothing(getAccess)&&(getAccess=!1),isService=!1,"string"==typeof queryOrService?0!==queryOrService.indexOf("select ")&&(isService=!0):isNothing(queryOrService)&&(isNothing(this.query)?(queryOrService="select ",queryOrService+=this.fields.join(", "),queryOrService+=" from ",queryOrService+=this.objectType,isNothing(this.where)||(queryOrService+=" where "+this.where),isNothing(this.order)||(queryOrService+=" order by "+this.order),isNothing(this.nullsLast)||(queryOrService+=" nulls last")):queryOrService=this.query),isNothing(successHandle)&&(successHandle=this.defaultSuccessLoadHandle),isNothing(errorHandle)&&(errorHandle=this.defaultErrorLoadHandle),isService)callService({service:queryOrService,params:params,successCallback:successHandle,errorCallback:errorHandle,context:this});else{var t;t=getAccess?this.getAttribute("_service")+"."+this.getAttribute("_loadWithAccess"):this.getAttribute("_service")+"."+this.getAttribute("_load"),callService({service:t,params:[queryOrService],successCallback:successHandle,errorCallback:errorHandle,context:this})}},save:function(e){objectType=e.objectType,successHandle=e.successHandle,errorHandle=e.errorHandle,isNothing(successHandle)&&(successHandle=this.defaultSuccessSaveHandle),isNothing(errorHandle)&&(errorHandle=this.defaultErrorSaveHandle),callService({service:this.getAttribute("_service")+"."+this.getAttribute("_save"),params:[objectType,this.format()],successCallback:successHandle,errorCallback:errorHandle,context:this})},defaultSuccessSaveHandle:function(e,t){t.absorb(e.records[0]),t.trigger("save:success",{result:e})},defaultErrorSaveHandle:function(e,t){t.trigger("save:error",{result:e}),console.log(e),console.log(e.message)},defaultSuccessLoadHandle:function(e,t){var i=new sObjects;isNothing(e.accessRecords)?i.absorb(e.records):i.absorb(e.accessRecords),t.reset(i.models),_.each(t.models,function(e){e.collection=t}),t.trigger("load:success",{result:e})},defaultErrorLoadHandle:function(e,t){flashMessage({message:"Error: "+e.message}),t.trigger("load:error",{result:e}),console.log(e),console.log(e.message)}});var SERVICE_TEST=!1,SERVICE_TEST_OBJECT="",SERVICE_TEST_RESULT_TYPE="success",DatagridModel=sObject.extend({defaults:{currentPage:1,pageSize:10,_service:null,_datagridService:"Service.datagrid",_baseQuery:null,whereClause:null,_searchClause:null,orderBy:null,sortField:null,sortDirection:null,rebuildQuery:!0,apexType:"DatagridSelector"},setSelectFields:function(e){var t=[],i=[];_.each(e,function(e){t.push(e.apiName),isNothing(e.name)?i.push(e.apiName):i.push(e.name)}),this.set({selectFields:t}),this.set({_columns:i}),this.set({_selectFields:e})},setWhereClause:function(e){this.set({whereClause:e,_whereClause:e})},getWhereClause:function(){whereClause=this.get("_whereClause"),isNothing(whereClause)&&(whereClause="");var e=this.getSearch();isNothing(e)||(whereClause+=""===whereClause?e:" "+e,isNothing(this.get("inClauseCount"))&&this.set({inClauseCount:0}),isNothing(this.get("_inClauseSearchCount"))||this.set({inClauseCount:this.get("inClauseCount")+this.get("_inClauseSearchCount")})),this.set({whereClause:whereClause})},getSearch:function(){var e=this.get("_searchTerm");return isNothing(e)?null:(searchClause=this.get("_searchClause"),searchClause.replace(/{TERM}/g,e))},loadDatagrid:function(){if(this.getWhereClause(),this.trigger("datagrid:loading"),null!==this.get("_service"))this.load(this.get("_service"));else{var e=this;this.callService({service:this.get("_datagridService"),params:[this.format()],successCallback:function(t){e.absorb(t.datagridSelector),e.trigger("datagrid:loaded")},errorCallback:function(t,i){flashMessage({message:"Failed to load datagrid"}),console.log(t),console.log(i),e.trigger("datagrid:error")}})}},resetDatagrid:function(){this.set({totalRecords:null,currentResult:null,currentResultSet:null,hasNext:null,hasPrevious:null,currentPage:1,pageSize:10,sortField:null,sortDirection:null,_searchTerm:null}),this.loadDatagrid()}}),DatagridView=Backbone.Marionette.CompositeView.extend({itemView:null,itemViewContainer:"tbody",template:"DatagridView",model:null,collection:new sObjects,initialize:function(e){this.model=e.model;var t=this;this.listenTo(this.model,"datagrid:loaded",this.listenToDatagridLoaded),this.listenTo(this.collection,"callservice:error",function(){t.collection.reset(),t.$el.unblock()}),this.listenTo(this.model,"datagrid:loading",function(){this.$el.block({message:"<h3>...loading...</h3>"})})},listenToDatagridLoaded:function(){this.collection.reset();var e=this.model.get("records");if(!isNothing(e)&&e.length>0){var t=new sObjects;t.absorb(this.model.get("records")),"function"==typeof this.beforeDatagridRender&&this.beforeDatagridRender(t),this.collection.reset(t.models),this.model.unset("records")}this.render(),"function"==typeof this.afterDatagridRender&&this.afterDatagridRender(this),this.$el.unblock()},events:{"click .btn-next":"next","click .btn-previous":"previous","click .btn-search":"search","click th":"sort","click .sortable":"sort","click .btn-reset":"resetDataGrid","keyup .search-term":"keyPressSearch","change .table-limit":"changeLimit"},onCompositeModelRendered:function(){this.$nextButton=this.$el.find(".btn-next"),this.$previousButton=this.$el.find(".btn-previous"),this.$pageNumber=this.$el.find(".page-number"),this.$searchTextBox=this.$el.find(".search-term"),this.$resetButton=this.$el.find(".btn-reset"),this.$headers=this.$el.find("th"),this.$currentPage=this.$el.find(".current-page"),this.$currentPageSet=this.$el.find(".current-page-set"),this.$totalRecords=this.$el.find(".total-records"),this.$limitSelect=this.$el.find(".table-limit"),!this.model.get("hasPrevious")&&isNothing(this.model.get("_searchTerm"))&&isNothing(this.model.get("sort-field"))||this.$resetButton.show(),$sortedColumn=this.$el.find('th[sort-direction="desc"]'),$sortedColumn.append('<i style="margin-left: 3px;" class="icon-arrow-down">'),$sortedColumn=this.$el.find('th[sort-direction="asc"]'),$sortedColumn.append('<i style="margin-left: 3px;" class="icon-arrow-up">')
},next:function(e){$(e.target).hasClass("disabled")||(this.model.set({currentPage:this.model.get("currentPage")+1}),this.model.loadDatagrid())},previous:function(e){$(e.target).hasClass("disabled")||(page=this.model.get("currentPage"),1!=page&&(this.model.set({currentPage:page-1}),this.model.loadDatagrid()))},keyPressSearch:function(e){13==e.keyCode&&this.search()},search:function(){this.model.set({_searchTerm:this.$searchTextBox.val()}),this.firstPage(),this.model.loadDatagrid()},changeLimit:function(){this.model.set({pageSize:parseInt(this.$limitSelect.val(),10)}),this.model.loadDatagrid()},resetDataGrid:function(){this.$headers.removeClass("sort-desc, sort-asc").removeAttr("sort-direction").find("i").remove(),this.$searchTextBox.val(""),this.model.resetDatagrid()},sort:function(e){$sortObject=$(e.currentTarget),void 0!==$sortObject.attr("sort-field")?(dir=$sortObject.attr("sort-direction"),this.$headers.removeClass("sort-desc, sort-asc").removeAttr("sort-direction").find("i").remove(),null===dir||"asc"==dir?(dir="desc",$sortObject.append('<i style="margin-left: 3px;" class="icon-arrow-down">')):($sortObject.append('<i style="margin-left: 3px;" class="icon-arrow-up">'),dir="asc"),$sortObject.attr("sort-direction",dir),this.model.set({sortField:$sortObject.attr("sort-field"),sortDirection:dir,currentPage:1}),this.model.loadDatagrid()):flashMessage({message:"<h3>This column does not support sorting.</h3>",duration:1500})},firstPage:function(){this.model.set({currentPage:1})},updatePageCount:function(){this.$pageNumber.text(this.model.get("page"))}});Handlebars.registerHelper("sortFieldDirection",function(e,t,i){return e===t?"sort-direction="+i:""});var TestDataModule=new Backbone.Marionette.Application;TestDataModule.on("initialize:after",function(){this.addRegions({content:"#test-service-content"});var e=new TestDataView;this.content.show(e),SERVICE_TEST_OBJECT="TestDataService"}),TestDataModule.vent.on("service:switch",function(e){SERVICE_TEST=e.serviceOn}),TestDataModule.vent.on("service:type",function(e){SERVICE_TEST_RESULT_TYPE=e.type,"success"==e.type?flashMessage({message:"Service Test Data - Success Data"}):flashMessage({message:"Service Test Data - Failure Data"})});var TestDataView=Backbone.Marionette.ItemView.extend({template:"TestDataView",model:new sObject,initialize:function(){this.model.set({serviceStatus:SERVICE_TEST,serviceType:SERVICE_TEST_RESULT_TYPE})},onShow:function(){this.changeServiceStatus()},events:{"click #service-on-off":"changeServiceStatus","click #service-type":"changeServiceType"},changeServiceStatus:function(){this.model.set({serviceStatus:!this.model.get("serviceStatus")}),TestDataModule.vent.trigger("service:switch",{serviceOn:!this.model.get("serviceStatus")}),this.model.get("serviceStatus")?this.$el.find("a#service-on-off").text("Service Test Off").removeClass("btn-warning").addClass("btn-primary"):this.$el.find("a#service-on-off").text("Service Test On").removeClass("btn-primary").addClass("btn-warning")},changeServiceType:function(){}});